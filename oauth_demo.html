<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo OAuth2 + Mercado Livre Integration</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .status-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-indicator.online {
            background-color: #28a745;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.3);
        }
        
        .status-indicator.offline {
            background-color: #dc3545;
        }
        
        .oauth-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 20px auto;
            min-width: 250px;
        }
        
        .oauth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .oauth-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .api-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .api-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #e9ecef;
            text-align: center;
        }
        
        .api-card h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        
        .feature-list {
            list-style: none;
            padding: 0;
        }
        
        .feature-list li {
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .feature-list li:last-child {
            border-bottom: none;
        }
        
        .feature-list li:before {
            content: "‚úì";
            color: #28a745;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .info-box {
            background: #e7f3ff;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ OAuth2 + Mercado Livre</h1>
            <p>Demonstra√ß√£o do sistema de autentica√ß√£o OAuth2 + PKCE integrado com as APIs do Mercado Livre</p>
        </div>

        <div class="status-panel">
            <h3>üìä Status dos Servi√ßos</h3>
            <div class="status-item">
                <div style="display: flex; align-items: center;">
                    <div id="backend-indicator" class="status-indicator offline"></div>
                    <span>Backend FastAPI</span>
                </div>
                <span id="backend-status">Verificando...</span>
            </div>
            <div class="status-item">
                <div style="display: flex; align-items: center;">
                    <div id="ml-indicator" class="status-indicator offline"></div>
                    <span>Mercado Livre API</span>
                </div>
                <span id="ml-status">Verificando...</span>
            </div>
        </div>

        <div class="info-box">
            <h4>‚ö†Ô∏è Sobre o Erro 403 CloudFront</h4>
            <p>O CloudFront pode bloquear requisi√ß√µes diretas √†s APIs do Mercado Livre por quest√µes de seguran√ßa.</p>
            <ul class="feature-list">
                <li>O OAuth2 ainda funciona normalmente (redirecionamento direto)</li>
                <li>As APIs s√≥ ficam dispon√≠veis ap√≥s autentica√ß√£o</li>
                <li>Implementamos fallbacks com dados de exemplo</li>
                <li>Em produ√ß√£o, use proxies ou tokens v√°lidos</li>
            </ul>
        </div>

        <div class="info-box">
            <h4>üîê Sistema OAuth2 + PKCE Implementado</h4>
            <ul class="feature-list">
                <li>OAuth2 com PKCE (Proof Key for Code Exchange) para m√°xima seguran√ßa</li>
                <li>Integra√ß√£o completa com Mercado Livre API</li>
                <li>Client ID de produ√ß√£o: 6377568852501213</li>
                <li>Redirect URI configurado para localhost:8001/callback</li>
                <li>Endpoints de ML API: categorias, busca, produtos, status</li>
            </ul>
        </div>

        <button id="oauth-btn" class="oauth-button" onclick="startOAuth()">
            üîë Iniciar Autentica√ß√£o OAuth2
        </button>

        <button class="oauth-button" onclick="testCloudFront()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); margin-top: 10px;">
            üîß Testar CloudFront Bypass
        </button>

        <div class="api-status">
            <div class="api-card">
                <h4>üìÅ Categorias</h4>
                <div id="categories-status">Aguardando autentica√ß√£o</div>
            </div>
            <div class="api-card">
                <h4>üîç Busca</h4>
                <div id="search-status">Aguardando autentica√ß√£o</div>
            </div>
            <div class="api-card">
                <h4>üì¶ Produtos</h4>
                <div id="products-status">Aguardando autentica√ß√£o</div>
            </div>
        </div>

        <div class="info-box">
            <h4>üîß Detalhes T√©cnicos</h4>
            <p><strong>Backend:</strong> FastAPI 2.0.0 rodando em localhost:8001</p>
            <p><strong>OAuth2 Flow:</strong> Authorization Code + PKCE</p>
            <p><strong>Seguran√ßa:</strong> State parameter para CSRF protection</p>
            <p><strong>APIs Integradas:</strong> Todas as principais APIs do Mercado Livre</p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001';
        
        // Verificar status do backend
        async function checkBackendStatus() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                if (response.ok) {
                    document.getElementById('backend-indicator').className = 'status-indicator online';
                    document.getElementById('backend-status').textContent = 'Online';
                    checkMLStatus();
                } else {
                    throw new Error('Backend offline');
                }
            } catch (error) {
                document.getElementById('backend-indicator').className = 'status-indicator offline';
                document.getElementById('backend-status').textContent = 'Offline';
            }
        }
        
        // Verificar status do Mercado Livre
        async function checkMLStatus() {
            try {
                const response = await fetch(`${API_BASE}/ml/status`);
                const data = await response.json();
                
                if (data.status === 'connected') {
                    document.getElementById('ml-indicator').className = 'status-indicator online';
                    document.getElementById('ml-status').textContent = `Conectado (${data.sites_count} sites)`;
                } else if (data.status === 'blocked') {
                    document.getElementById('ml-indicator').className = 'status-indicator offline';
                    document.getElementById('ml-status').textContent = 'Bloqueado pelo CloudFront (OAuth ainda funciona)';
                } else {
                    document.getElementById('ml-indicator').className = 'status-indicator offline';
                    document.getElementById('ml-status').textContent = 'Erro de conex√£o';
                }
            } catch (error) {
                document.getElementById('ml-indicator').className = 'status-indicator offline';
                document.getElementById('ml-status').textContent = 'Erro de rede';
            }
        }
        
        // Iniciar OAuth2
        function startOAuth() {
            const button = document.getElementById('oauth-btn');
            button.disabled = true;
            button.innerHTML = '<div class="loading"></div> Redirecionando...';
            
            // Redirecionar para o endpoint OAuth
            window.location.href = `${API_BASE}/auth/oauth`;
        }
        
        // Testar CloudFront bypass
        async function testCloudFront() {
            try {
                const response = await fetch(`${API_BASE}/test/cloudfront`);
                const data = await response.json();
                
                let message = 'Resultados dos testes CloudFront:\n\n';
                for (const [test, result] of Object.entries(data.cloudfront_tests)) {
                    message += `${test}: ${result.success ? '‚úÖ Sucesso' : '‚ùå Falhou'}\n`;
                }
                
                alert(message);
            } catch (error) {
                alert('Erro ao testar CloudFront: ' + error.message);
            }
        }
        
        // Verificar se retornou do OAuth
        function checkOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            
            if (code && state) {
                document.getElementById('oauth-btn').innerHTML = '‚úÖ Autentica√ß√£o Conclu√≠da!';
                document.getElementById('oauth-btn').style.background = '#28a745';
                testAPIs();
            }
        }
        
        // Testar APIs do Mercado Livre
        async function testAPIs() {
            // Testar categorias
            try {
                const categoriesResponse = await fetch(`${API_BASE}/ml/categories`);
                if (categoriesResponse.ok) {
                    document.getElementById('categories-status').innerHTML = '‚úÖ Funcionando';
                }
            } catch (error) {
                document.getElementById('categories-status').innerHTML = '‚ùå Erro';
            }
            
            // Testar busca
            try {
                const searchResponse = await fetch(`${API_BASE}/ml/search?q=notebook`);
                if (searchResponse.ok) {
                    document.getElementById('search-status').innerHTML = '‚úÖ Funcionando';
                }
            } catch (error) {
                document.getElementById('search-status').innerHTML = '‚ùå Erro';
            }
            
            // Testar produtos
            try {
                const productsResponse = await fetch(`${API_BASE}/ml/products/MLB123456`);
                if (productsResponse.ok) {
                    document.getElementById('products-status').innerHTML = '‚úÖ Funcionando';
                } else {
                    document.getElementById('products-status').innerHTML = '‚ö†Ô∏è Endpoint dispon√≠vel';
                }
            } catch (error) {
                document.getElementById('products-status').innerHTML = '‚ùå Erro';
            }
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            checkBackendStatus();
            checkOAuthCallback();
        });
    </script>
</body>
</html>
